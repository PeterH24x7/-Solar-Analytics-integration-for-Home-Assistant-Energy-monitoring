# -----------------------------------------------------------------------------
#
# AMBER extras integration for Home Assistant Energy Management. 
# Requires HA Amber Electric Integration to be installed.
# 
# Developed by Peter Hormann
#
# Created: 9-Feb-2023
#
# Last updated: 13-Dec-25
#
# Updates: 
#   2-Jun-23 - improved error checking for when nem_date is not defined.
#   13-Dec-25 - to meet modern template sensor format (old format to be deprecated 30-Jun-26).
#   7-Jan-26 - fixed system log error when nem_date doesn't exist (amber data is trucated).
#
# Creates a new "amber_forecast" sensor which contains the curent time and 24 hours 
# future time in 30 minute increments, the general forecast prices and the feed-in 
# forecast prices stored in an array format suitable for use by a Apex Chart card 
# (installed via HACS) - see <amber_forecast_chart.yaml> for the card YAML code.
#
# Installation: 
#   1. Copy this yaml file to the HA config directory.
#   2. Include this file name as a package in the HA <configuration.yaml>. 
#      For example -
#        packages:
#          pack_1: !include amber_forecast.yaml
#   3. Rename "amber12ayrst_xyz" sensors to match HA Amber installation device naming.
#   4. Ensure the Developer Tools > YAML > Check Configuration passes without error.
#   5. Restart HA, or simply use YAML Configuration Reloading > Template Entities.
#   6. Enjoy!
#
# If you find my work useful, please buy me a coffee ... thank you!
#   https://www.buymeacoffee.com/peter24x7
#
# Reference for more information and updates:
#   https://github.com/PeterH24x7/-Solar-Analytics-integration-for-Home-Assistant-Energy-monitoring
#
# -----------------------------------------------------------------------------

template:
  - sensor:
      - name: "Amber Forecast"
        default_entity_id: sensor.amber_forecast
        unique_id: amber_forecast
        icon: mdi:chart-line
        state: >

          {%- set nem_date = state_attr('sensor.amber12ayrst_general_price', 'nem_date') -%}
          {%- if nem_date is defined and nem_date is not none and nem_date != '' -%}
            {{- as_local(as_datetime(nem_date) - timedelta(minutes=30)).strftime("%Y-%m-%d %H:%M:%S") -}}
          {%- else -%}
            {{- states('sensor.amber_forecast') if states('sensor.amber_forecast') != 'unknown' else 'unavailable' -}}
          {%- endif -%}

        attributes: 
          times: >-

            {%- set nem_date = state_attr('sensor.amber12ayrst_general_price', 'nem_date') -%}
            {%- set today = state_attr('sensor.amber12ayrst_general_forecast', 'forecasts') -%}
            {%- if nem_date is defined and today is defined and today is iterable -%}
              {%- set ns = namespace(times = [as_local(as_datetime(nem_date) - timedelta(minutes=30)).strftime("%Y-%m-%d %H:%M:%S")]) -%}
              {%- for hours in today -%}
                {%- if 'nem_date' in hours -%}
                  {%- set ns.times = ns.times + [as_local(as_datetime(hours.nem_date) - timedelta(minutes=30)).strftime("%Y-%m-%d %H:%M:%S")] -%}
                {%- endif -%}
              {%- endfor -%}
              {{- ns.times -}}
            {%- else -%}
              {{- state_attr('sensor.amber_forecast', 'times') if state_attr('sensor.amber_forecast', 'times') is defined else 'unavailable' -}}
            {%- endif -%}

          general_price: >-

            {%- set nem_date = state_attr('sensor.amber12ayrst_general_price', 'nem_date') -%}
            {%- set today = state_attr('sensor.amber12ayrst_general_forecast', 'forecasts') -%}
            {%- if nem_date is defined and today is defined and today is iterable -%}
              {%- set ns = namespace(general = [states('sensor.amber12ayrst_general_price')|float]) -%}
              {%- for hours in today -%}
                {%- if 'nem_date' in hours and 'per_kwh' in hours -%}
                  {%- set ns.general = ns.general + [hours.per_kwh] -%}
                {%- endif -%}
              {%- endfor -%}
              {{- ns.general -}}
            {%- else -%}
              {{- state_attr('sensor.amber_forecast', 'general_price') if state_attr('sensor.amber_forecast', 'general_price') is defined else 'unavailable' -}}
            {%- endif -%}

          fit_price: >-

            {%- set nem_date = state_attr('sensor.amber12ayrst_general_price', 'nem_date') -%}
            {%- set today = state_attr('sensor.amber12ayrst_general_forecast', 'forecasts') -%}
            {%- if nem_date is defined and today is defined and today is iterable -%}
              {%- set ns = namespace(fit = [state_attr('sensor.amber12ayrst_general_price', 'spot_per_kwh')|float]) -%}
              {%- for hours in today -%}
                {%- if 'nem_date' in hours and 'spot_per_kwh' in hours -%}
                  {%- set ns.fit = ns.fit + [hours.spot_per_kwh] -%}
                {%- endif -%}
              {%- endfor -%}
              {{- ns.fit -}}
            {%- else -%}
              {{- state_attr('sensor.amber_forecast', 'fit_price') if state_attr('sensor.amber_forecast', 'fit_price') is defined else 'unavailable' -}}
            {%- endif -%}

          renewables_percent: >-

            {%- set nem_date = state_attr('sensor.amber12ayrst_general_price', 'nem_date') -%}
            {%- set today = state_attr('sensor.amber12ayrst_general_forecast', 'forecasts') -%}
            {%- if nem_date is defined and today is defined and today is iterable -%}
              {%- set ns = namespace(renewables = [state_attr('sensor.amber12ayrst_general_price', 'renewables')|float]) -%}
              {%- for hours in today -%}
                {%- if 'nem_date' in hours and 'renewables' in hours -%}
                  {%- set ns.renewables = ns.renewables + [hours.renewables] -%}
                {%- endif -%}
              {%- endfor -%}
              {{- ns.renewables -}}
            {%- else -%}
              {{- state_attr('sensor.amber_forecast', 'renewables_percent') if state_attr('sensor.amber_forecast', 'renewables_percent') is defined else 'unavailable' -}}
            {%- endif -%}

# -----------------------------------------------------------------------------
